version: 2.1

commands:
  bundle-install:
    steps:
      - restore_cache:
          keys:
            - v1-identity-devops-bundle-{{ checksum "Gemfile.lock" }}
      - run:
          name: Install dependencies
          command: |
            bundle check || bundle install --deployment --jobs=4 --retry=3  --path vendor/bundle
      - save_cache:
          key: v1-identity-devops-bundle-{{ checksum "Gemfile.lock" }}
          paths:
            - vendor/bundle

jobs:
  setup:
    docker:
      - image: cimg/ruby:2.7
    working_directory: /tmp/identity-devops
    steps:
      - checkout
      - persist_to_workspace:
          root: .
          paths:
            - .
  tf-fmt-check:
    docker:
      # TODO - Pin this!
      - image: hashicorp/terraform
    working_directory: /tmp/identity-devops
    steps:
      - attach_workspace:
          at: .
      - run: terraform fmt -recursive -diff -check ./terraform
  tfsec-check-soft:
    docker:
      # TODO - Pin this!
      - image: aquasec/tfsec-ci
    working_directory: /tmp/identity-devops
    parameters:
      folder:
        type: string
    steps:
      - attach_workspace:
          at: .
      # Used to advise for now - Remove the --soft-fail when ready to ENFORCE :ed209:
      - run: tfsec --no-color --soft-fail terraform/<< parameters.folder >>

  tfsec-check-enforce:
    docker:
      - image: aquasec/tfsec-ci
    working_directory: /tmp/identity-devops
    parameters:
      folder:
        type: string
    steps:
      - attach_workspace:
          at: .
      # Used to advise for now - Remove the --soft-fail when ready to ENFORCE :ed209:
      - run: tfsec --no-color terraform/<< parameters.folder >>
  ruby_test:
    docker:
      - image: cimg/ruby:2.7
    working_directory: /tmp/identity-devops
    steps:
      - attach_workspace:
          at: .
      - bundle-install
      - run: bundle exec rspec cloudlib/spec


workflows:
  version: 2
  lint:
    jobs:
      - setup
      - tf-fmt-check:
          requires:
            - setup
  sast:
    jobs:
      - setup
      - tfsec-check-soft:
          requires:
            - setup
          matrix:
            parameters:
              folder:
                # Scanning top level modules to avoid extreme duplication
                - all/module
                - app
                - core/module
                - gitlab/module
                - modules
                - sms/module
                - tooling/module
                - waf/module
      - tfsec-check-enforce:
          requires:
            - setup
          matrix:
            parameters:
              # Add folders that should be vuln free and STAY THAT WAY
              folder:
                - imagebuild/module
                - master/module
                - tooling/module-gitlabpipeline
                - tooling/module-pipeline
  tests:
    jobs:
      - setup
      - ruby_test:
          requires:
            - setup
