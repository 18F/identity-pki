#!<%= @ruby %>

require 'elasticsearch'
require 'json'
require 'ohai'

healthdata = {}
healthdata['event_type'] = 'ElasticSearchHealthSample'

# Get ES health data
client = Elasticsearch::Client.new \
  url: 'https://localhost:9200',
  transport_options: { ssl: { verify: false } }
rawhealthdata = client.cluster.health
rawhealthdata.keys.each do |k|
  healthdata['es_' + k] = rawhealthdata[k]
end

# get disk space info
ohai = Ohai::System.new
ohai.all_plugins
begin
  percentstring = ohai['filesystem']['by_mountpoint']['/var/lib/elasticsearch']['percent_used']
  healthdata['es_diskpercentused'] = percentstring.to_i
rescue
  begin
    percentstring = ohai['filesystem']['by_mountpoint']['/var']['percent_used']
    healthdata['es_diskpercentused'] = percentstring.to_i
  rescue
    healthdata['es_diskpercentused'] = -1
  end    
end

data = {
  name: 'elasticsearch_health',
  protocol_version: '1',
  integration_version: '1.0.0',
  metrics: [ healthdata ]
}

puts JSON.generate(data)
