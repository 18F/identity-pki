#!<%= @ruby %>

require 'elasticsearch'
require 'json'
require 'socket'

healthdata = {}
healthdata['event_type'] = 'ElasticSearchHealthSample'

# Get ES health data
client = Elasticsearch::Client.new \
  url: 'https://localhost:9200',
  transport_options: { ssl: { verify: false } }
rawhealthdata = client.cluster.health
rawhealthdata.keys.each do |k|
  healthdata['es_' + k] = rawhealthdata[k]
end

# get disk space info
diskdata = client.cat.allocation(format: 'JSON')
hostname = Socket.gethostname
mydiskdata = diskdata.select { |d| d['node'] == hostname }
healthdata['es_diskpercentused'] = mydiskdata.first['disk.percent']
healthdata['es_diskused'] = mydiskdata.first['disk.used']
healthdata['es_diskavail'] = mydiskdata.first['disk.avail']
healthdata['es_disktotal'] = mydiskdata.first['disk.total']
healthdata['es_shards'] = mydiskdata.first['shards']


data = {
  name: 'elasticsearch_health',
  protocol_version: '1',
  integration_version: '1.0.0',
  metrics: [ healthdata ]
}

puts JSON.generate(data)
