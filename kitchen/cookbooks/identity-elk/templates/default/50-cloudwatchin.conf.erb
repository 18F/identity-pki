input {
  cloudwatch_logs {
    log_group => "<%= @env %>_flow_log_group"
    region => "<%= @aws_region %>"
    type => "cw_flowlog"
    sincedb_path => "/usr/share/logstash/.sincedb_cloudwatch_flowlog"
    start_position => "end"
  }
}

input {
  cloudwatch_logs {
    log_group => "/aws/lambda/<%= @env %>-cloudwatch-kms"
    region => "<%= @aws_region %>"
    type => "cw_kms"
    sincedb_path => "/usr/share/logstash/.sincedb_cloudwatch_kms"
    start_position => "end"
  }
}

input {
  cloudwatch_logs {
    log_group => "/aws/rds/instance/login-<%= @env %>-idp/postgresql"
    region => "<%= @aws_region %>"
    type => "cw_postgres"
    sincedb_path => "/usr/share/logstash/.sincedb_cloudwatch_postgres"
    start_position => "end"
  }
}

input {
  cloudwatch_logs {
    log_group => "/aws/kinesisfirehose/aws-waf-logs-<%= @env %>-idp-waf-firehose-s3-stream"
    region => "<%= @aws_region %>"
    type => "cw_waf"
    sincedb_path => "/usr/share/logstash/.sincedb_cloudwatch_waf"
    start_position => "end"
  }
}

filter {
  if [type] == "cw_flowlog" {
    grok {
      match => { "message" => "%{NUMBER:version} %{NUMBER:account-id} %{NOTSPACE:interface-id} %{NOTSPACE:srcaddr} %{NOTSPACE:dstaddr} %{NOTSPACE:srcport} %{NOTSPACE:dstport} %{NOTSPACE:protocol} %{NOTSPACE:packets} %{NOTSPACE:bytes} %{NUMBER:start} %{NUMBER:end} %{NOTSPACE:action} %{NOTSPACE:log-status}" }
    }
    if "-" in [bytes] {
      mutate {
        replace => { "bytes" => "0" }
      }
    }
    if "-" in [dstaddr] {
      mutate {
        replace => { "dstaddr" => "0.0.0.0" }
      }
    }
    if "-" in [dstport] {
      mutate {
        replace => { "dstport" => "0" }
      }
    }
    geoip {
        # perform a geoip lookup on the dstaddr
        source => "dstaddr"
    }
    if "-" in [packets] {
      mutate {
        replace => { "packets" => "0" }
      }
    }
    if "-" in [protocol] {
      mutate {
        replace => { "protocol" => "0" }
      }
    }
    if "-" in [srcaddr] {
      mutate {
        replace => { "srcaddr" => "0.0.0.0" }
      }
    }
    if "-" in [srcport] {
      mutate {
        replace => { "srcport" => "0" }
      }
    }
    geoip {
        # perform a geoip lookup on the dstaddr
        source => "srcaddr"
    }
  }
}
