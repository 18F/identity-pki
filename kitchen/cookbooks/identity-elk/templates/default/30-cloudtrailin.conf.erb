input {
   s3 {
     region => "<%= @aws_region %>"
     bucket => "<%= @cloudtrail_logging_bucket %>"
     type => "cloudtrail"
     codec => "cloudtrail"
     exclude_pattern => ".*\/CloudTrail\-Digest\/.*"
   }
}

filter {
  if [type] == "cloudtrail" {
    ruby {
      code => "event.set('additionalEventData', event.get('additionalEventData').inspect)"
    }
    mutate {
      gsub => [ "eventSource", "\.amazonaws\.com$", "" ]
      add_field => {
        "document_id" => "%{eventID}"
      }
    }
    mutate {
      add_field => {
        "document_type" => "%{type}"
      }
    }
    if ! [ingest_time] {
      mutate {
        add_field => [ "ingest_time", "%{@timestamp}" ]
      }
    }
  }
}

