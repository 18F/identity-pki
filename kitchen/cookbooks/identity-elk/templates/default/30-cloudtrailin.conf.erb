input {
   s3 {
     region => "<%= @aws_region %>"
     bucket => "<%= @cloudtrail_logging_bucket %>"
     proxy_uri => "<%= @proxy_uri %>"
     type => "cloudtrail"
     codec => "cloudtrail"
     exclude_pattern => ".*\/CloudTrail\-Digest\/.*"
     sincedb_path => "/usr/share/logstash/.sincedb_cloudtraillogstash"
   }
}

filter {
  if [type] == "cloudtrail" {
    ruby {
      code => "event.set('additionalEventData', event.get('additionalEventData').inspect)"
    }
    mutate {
      gsub => [ "eventSource", "\.amazonaws\.com$", "" ]
      add_field => {
        "document_id" => "%{eventID}"
      }
    }
    if ! [ingest_time] {
      mutate {
        add_field => [ "ingest_time", "%{@timestamp}" ]
      }
    }
  }
}

