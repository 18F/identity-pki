server {
    listen        443;
    ssl on;
    server_name  <%= @server_name or raise 'no @server_name' %>;


    ssl_certificate      /etc/letsencrypt/live/<%= @ssl_domain or raise 'no @ssl_domain' %>/fullchain.pem;
    ssl_certificate_key  /etc/letsencrypt/live/<%= @ssl_domain or raise 'no @ssl_domain' %>/privkey.pem;
    ssl_verify_client optional_no_ca; # on;
    ssl_verify_depth 10;

    access_log  /var/log/nginx/access.log  fancy_log;

    location / {
        root           /usr/local/var/www;

	proxy_pass http://localhost:3001;

        proxy_set_header X-Real-Host $host;
        proxy_set_header X-Real-Ip $remote_addr;
        proxy_set_header X-Real-Proto https;
        proxy_set_header X-Client-Verify $ssl_client_verify;
        proxy_set_header X-Client-S-Dn $ssl_client_s_dn;
        proxy_set_header X-Client-I-Dn $ssl_client_i_dn;
        proxy_set_header X-Client-Serial $ssl_client_serial;
        proxy_set_header X-Client-Fingerprint $ssl_client_fingerprint;
        proxy_set_header X-Client-Cert $ssl_client_escaped_cert;
    }
}

server {
    listen       127.0.0.1:3001;
    server_name  pivcac_rails;
    root "/srv/pki-rails/current/public";
    passenger_enabled on;
    passenger_ruby "<%= @passenger_ruby or raise 'no @passenger_ruby' %>";
    rails_env production;
}
