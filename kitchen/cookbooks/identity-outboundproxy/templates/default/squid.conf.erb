# This file generated from a Chef template.
# identity-outboundproxy/templates/default.squid.conf.erb

# CONNECT HTTPS
acl SSL_ports port 443

# CONNECT AAMVA
acl SSL_ports port 18449

# CONNECT GSA Public Bigfix Relay Server
acl SSL_ports port 52311

# CONNECT Experian
acl SSL_ports port 8443

# FTP
acl Safe_ports port 21
# HTTP
acl Safe_ports port 80
# HTTPS
acl Safe_ports port 443

# Unregistered ports, probably not used anywhere
#acl Safe_ports port 1025-65535

acl purge method PURGE
acl CONNECT method CONNECT

acl localhost src 127.0.0.1/32 ::1
acl to_localhost dst 127.0.0.0/8 0.0.0.0/32 ::1
acl vpc src <%= @vpc_cidr or raise 'no @vpc_cidr' %>

acl urls dstdomain "/etc/squid/domain-allowlist.conf"
acl deny-urls dstdomain "/etc/squid/domain-denylist.conf"
acl ips dst "/etc/squid/ip-allowlist.conf"

# Order matters for http_access rules! The first matching rule will apply, so
# put allow rules as late as possible.

# Deny to localhost, unexpected HTTP / HTTPS ports
http_access deny to_localhost
http_access deny !Safe_ports !SSL_ports
http_access deny CONNECT !SSL_ports

# Deny manager / purge except from localhost
http_access allow manager localhost
http_access deny manager
http_access allow purge localhost
http_access deny purge

# Allow clients in VPC to connect to whitelisted domains and IP addresses
http_access deny vpc deny-urls
http_access allow vpc urls
http_access allow vpc ips
http_access deny vpc all

# Allow clients on localhost to connect to whitelisted domains and IP addresses
http_access deny localhost deny-urls
http_access allow localhost urls
http_access allow localhost ips

# Deny by default
http_access deny all

icp_access allow vpc
icp_access deny all

http_port 3128

# just like the standard squid log, but adds client source port %>p
logformat custom_squid  %ts.%03tu %6tr %>a:%>p %Ss/%03>Hs %<st %rm %ru %[un %Sh/%<a %mt

access_log /var/log/squid/access.log custom_squid

# Disable the ICMP pinger, which runs suid root and isn't super useful
pinger_enable off

refresh_pattern     ^ftp:                       1440    20%     10080
refresh_pattern     ^gopher:                    1440    0%      1440
refresh_pattern     -i (/cgi-bin/|\?)           0       0%      0
refresh_pattern     (Release|Package(.gz)*)$    0       20%     2880
# refresh_pattern           \.deb$                      1440    20%     10080
# refresh_pattern           \.rpm$                      1440    20%     10080
# refresh_pattern           \.iso$                      1440    20%     10080
# refresh_pattern           \.$                 1440    20%     10080
# refresh_pattern           .                           0       20%     4320
hosts_file /etc/hosts
maximum_object_size 1024 MB
cache_dir ufs /var/spool/squid 10000 16 256
coredump_dir /var/spool/squid
cache_mem 2048 MB
