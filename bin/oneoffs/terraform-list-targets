#!/bin/bash

set -euo pipefail

usage() {
    cat >&2 <<EOM
usage: $(basename "$0") [FILE]

Read a terraform plan text from FILE (or stdin), and print all of the targets
that it names for addition, destruction, or modification (all lines that start
with "+", "-", or "~").

This is useful if you want a list of all -target resource names that a plan
produces.

Examples:

    terraform plan | $0
EOM
}

case $# in
    0)
        # read from stdin if it's not a TTY
        if [ -t 0 ]; then
            usage
            exit 1
        else
            file='-'
        fi
        ;;
    1)
        file="$1"
        ;;
    *)
        usage
        exit 1
        ;;
esac

# Strip terminal escape sequences
strip_ansi_color() {
    # Use ruby instead of sed since GNU/BSD sed are inconsistent with \e
    # shellcheck disable=SC2016
    ruby -n -e 'puts $_.gsub(/\x1B\[([0-9]{1,2}(;[0-9]{1,2})?)?[m|K]/, "")'
}

cat -- "$file" | strip_ansi_color | grep '^[+~-]' | cut -f2 -d' ' | while read -r line; do
    echo -n "-target $line "
done

echo
