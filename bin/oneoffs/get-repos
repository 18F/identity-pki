#!/bin/bash

# Clone all `18F/identity` repos that identity-devops is dependent upon.
# Will prompt to also clone the identity-APP repos and create a
# stages/$GSA_USERNAME branch on each one.

set -eu

. "$(dirname "$0")/../lib/common.sh"

usage() {
    cat >&2 << EOM

Usage: ${0}

Runs \`git clone\` for all repos in the 18F GitHub org which the
identity-devops repo is dependent upon. All local clones are
placed in the parent directory from where identity-devops
resides on the system.

If desired, will also clone all of the identity-APP repos (as
used in the login_dot_gov cookbook) and create a personal
branch, \`stages/\$GSA_USERNAME\`, on each one, before
checking said repo back out to \`main\`.

EOM
}

clone_if_new() {
  local REPO=${1}
  REPO_DIR=$(echo $REPO | sed -e 's/.*\/\(identity-[a-z]\)/\1/g')
  if [ -d $REPO_DIR ] ; then
    cd $REPO_DIR >/dev/null
    if git rev-parse --is-inside-work-tree >/dev/null ; then
      echo_yellow "$REPO_DIR exists; skipping git clone."
    fi
    cd - >/dev/null
  else
    run git clone git@${REPO}.git
  fi
}

verify_stages_branch() {
  if [[ $(git branch 2>/dev/null | grep stages/${GSA_USERNAME}) ]] || \
     [[ $(git branch --remote 2>/dev/null | grep stages/${GSA_USERNAME}) ]] ; then
       echo_yellow "\`stages/${GSA_USERNAME}\` local/remote branches exist; skipping pull."
  else
    local CURRENT_BRANCH=$(git_current_branch)
    local REPO_NAME=$(git rev-parse --show-toplevel)
    echo_blue "Creating \`stages/${GSA_USERNAME}\` branch for ${REPO_NAME}..."
    run git checkout main
    run git pull origin main
    run git checkout -b stages/${GSA_USERNAME}
    run git push origin -u stages/${GSA_USERNAME}
    run git checkout ${CURRENT_BRANCH}
  fi
  echo
}

[ $# -gt 0 ] && raise 'No arguments needed'
verify_root_repo
which yq >/dev/null || raise 'yq not found; install with Homebrew'
verify_stages_branch

GIT_TOPLEVEL=$(echo ${GIT_DIR} | sed -E 's/\/[^/]*$/\//')
ALL_REPOS=$(yq '[ .[].[] ] | flatten | sort | unique | .[]' < ${GIT_DIR}/.repolist.yml)

run cd ${GIT_TOPLEVEL}
echo

for REPO in ${ALL_REPOS} ; do
  clone_if_new ${REPO}
done

echo
if ! prompt_yn "Create \`stages/${GSA_USERNAME}\` branches for the identity-APP repos? " ; then
  echo_yellow "Exiting."
  exit 0
else
  echo
  for APP in $(yq '[ .[].app ] | flatten | sort | unique | .[]' < ${GIT_DIR}/.repolist.yml) ; do

    clone_if_new ${APP}
    cd $(echo $APP | sed -e 's/.*\/\(identity-[a-z]\)/\1/g') >/dev/null
    verify_stages_branch
    cd - >/dev/null
  done
fi

run cd ${GIT_DIR}
echo
