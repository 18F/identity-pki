#!/bin/bash

# Sets up the basic groundwork (via Terraform) for an AWS account.
# Must be run as an actual IAM user (vs. with an assumed role)
# with the AdministrativeAccess IAM policy attached.

set -euo pipefail

. "$(dirname "$0")/../lib/common.sh"
. "$(dirname "$0")/../lib/acct-lib.sh"

howto() { echo "Usage: ${0} [-potbs12345] [-a SRC_ACCT] IAM_USER_PROFILE_NAME" ; }
usage() { echo -e "\n$(howto)\nUse -h for more info!\n" ; }
help_me() {
  cat >&2 << EOM

$(howto)

Runs all necessary tasks to set up the basic infrastructure (in terraform/all)
for a (new) AWS account, including assumable IAM roles and the AWS account alias.

Some secrets and parameters are copied from a separate account, \`login-SRC_ACCT\`,
as they cannot be created/managed within the codebase/Terraform code.
Defaults to 'sandbox', can be otherwise set with the -a flag if desired
(i.e. \`-a prod\` to pull from the \`login-prod\` account instead.)

MUST be run as an IAM user (/not/ an assumed role)
within said account, which has the AdministrativeAccess IAM policy attached,
identified in ~/.aws/config as \`IAM_USER_PROFILE_NAME\` (required argument).

The tasks in this script can also be individually executed as follows:

  -p, -1 : Creates the 'RDSDeletionPrevent' and 'RegionRestriction' IAM policies,
           which are attached to all assumable IAM roles and required for
           subsequent 'terraform apply' operations to work properly,
           and the login-secrets S3 bucket for the account.
           (Step: 1_policies_secrets_bucket)
  -o, -2 : Copies the 'common/opsgenie_sns_apikey' S3 object from the login-SRC_ACCT
           account into this account's 'secrets' bucket, required for the SNS topics
           for alerting to be properly created.
           (Step: 2_copy_opsgenie_key)
  -t, -3 : Import the 'terraform_locks' DynamoDB table -- created by bin/tf-deploy
           during its first run -- into Terraform state, so that it can be managed
           directly in code.
           (Step: 3_import_lock_table)
  -b, -4 : Runs 'terraform apply' in the account as the Terraform role, creating all
           remaining resources defined in the terraform/all directory.
           (Step: 4_build_acct)
  -s, -5 : Copies the /account/slack/webhook/url SSM parameter from login-SRC_ACCT
           to each region, allowing Terraform to send notifications to Slack
  -h     : Displays this help

EOM
}

# targeted deploy to create the custom policies and secrets bucket
# (both are needed for the second run to work properly)
1_policies_secrets_bucket() {
  bin/tf-deploy -t "all/${TF_ACCT}" apply -auto-approve \
    -target='module.main.aws_iam_policy.rds_delete_prevent' \
    -target='module.main.aws_iam_policy.region_restriction' \
    -target='module.main.module.main_secrets_bucket.aws_s3_bucket.secrets'
}

# get opsgenie key from $SRC_ACCT and put it in the new secrets bucket
2_copy_opsgenie_key() {
  get_secrets_bucket source
  OPSGENIE_KEY=$(bin/awsv -x ${AV_PROFILE} \
    aws s3 cp "s3://${SECRETS_BUCKET}/common/opsgenie_sns_apikey" -)
  get_secrets_bucket dest
  printf "${OPSGENIE_KEY}" | bin/awsv -x ${AV_PROFILE} \
    aws s3 cp - "s3://${SECRETS_BUCKET}/common/opsgenie_sns_apikey" \
      --no-guess-mime-type \
      --content-type="text/plain" \
      --metadata-directive="REPLACE"
}

# since configure_state_bucket.sh creates the DynamoDB table if it doesn't exist,
# import it into state so it can be managed within Terraform in subsequent runs
3_import_lock_table() {
  export AWS_PROFILE=${ADMIN_IAM_ROLE}
  bin/tf-deploy -t "all/${TF_ACCT}" import \
    'module.main.module.tf-state.aws_dynamodb_table.tf-lock-table[0]' 'terraform_locks'
}

# build the rest of terraform/all infra
4_build_acct() {
  export AWS_PROFILE=${ADMIN_IAM_ROLE}
  bin/tf-deploy -t "all/${TF_ACCT}" apply -auto-approve
}

# update the SSM slackwebhook parameters
5_slack_webhook_ssm_params() {
  local WEBHOOK_URL
  for REGION in 'us-west-2' 'us-east-1' ; do
    switch_creds source
    WEBHOOK_URL=$(printf "$(bin/awsv -x ${AV_PROFILE} aws ssm get-parameters \
                  --names '/account/slack/webhook/url' \
                  --region "${REGION}" \
                  --with-decryption | jq -r '.Parameters[].Value')")
    switch_creds dest
    bin/awsv -x ${AV_PROFILE} aws ssm put-parameter \
      --name '/account/slack/webhook/url' \
      --value "${WEBHOOK_URL}" \
      --region "${REGION}" \
      --type SecureString \
      --description 'Slack webhook url for notifications' --overwrite
  done

}

declare {TF_ACCT,ACCT_ID,SECRETS_BUCKET,ADMIN_IAM_ROLE}=
SRC_ACCT='sandbox'
verify_root_repo

TASKS=(
  "1_policies_secrets_bucket"
  "2_copy_opsgenie_key"
  "3_import_lock_table"
  "4_build_acct"
  "5_slack_webhook_ssm_params"
)
TODO=()

while getopts t1p2r3o4b5s6a:h opt
do
  case $opt in
    1|p) TODO+=("${TASKS[0]}") ;;
    2|o) TODO+=("${TASKS[1]}") ;;
    3|t) TODO+=("${TASKS[2]}") ;;
    4|b) TODO+=("${TASKS[3]}") ;;
    5|s) TODO+=("${TASKS[4]}") ;;
    a) SRC_ACCT="${OPTARG}"    ;;
    h) help_me                 ;;
    *) usage && exit 1         ;;
  esac
done
shift $((OPTIND-1))

ADMIN_IAM_ROLE=${1-}
[[ -z ${ADMIN_IAM_ROLE} ]] && raise "Must provide an IAM profile name!"
export AWS_PROFILE=${ADMIN_IAM_ROLE}

verify_account_info
if [[ ! -z "${ACCOUNT_ALIAS}" ]] && [[ -z "${TODO-}" ]] ; then
  echo_red "Account alias '${ACCOUNT_ALIAS}' already exists for '${TF_ACCT}'."
  raise "Account may already exist; use bin/td for Terraform commands instead!"
fi

run_tasks
