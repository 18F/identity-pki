#!/bin/bash
set -euo pipefail

# shellcheck source=/dev/null
. "$(dirname "$0")/lib/common.sh"

ONCELER_URL='https://onceler.app.cloud.gov/once/'
DEFAULT_GROUP='identity-interview-candidate'
DEFAULT_PROFILE='identity-interviews'

usage() {
    cat >&2 <<EOM
usage: $(basename "$0") USERNAME [AWS_PROFILE [IAM_GROUP]]

Create an IAM user for a Login.gov interviewee in the Login.gov interview
account. Add the user to IAM_GROUP for permissions.

Post the credentials to a multi-use secure clipboard at:
    $ONCELER_URL

Defaults:
    AWS_PROFILE: $DEFAULT_PROFILE
    IAM_GROUP:   $DEFAULT_GROUP
EOM
}

if [ $# -lt 1 ] || [ $# -gt 3 ]; then
    usage
    exit 1
fi

user="$1"

AWS_PROFILE="${2-"$DEFAULT_PROFILE"}"
export AWS_PROFILE
iam_group="${3-"$DEFAULT_GROUP"}"

echo_blue "Creating account for $user in IAM group $iam_group"
echo_blue "AWS_PROFILE: $AWS_PROFILE"

delete_after="$(run python -c 'import datetime; print(datetime.date.today() + datetime.timedelta(1))')"

password="$(run pwgen -sy 32 1)"

run aws iam create-user --user-name "$user"
run aws iam tag-user --user-name "$user" --tags \
    "Key=delete-after,Value=$delete_after" \
    "Key=created-by,Value=${GSA_USERNAME-$USER}"

# not super secure to put password on CLI, but we don't care for this use case
run aws iam create-login-profile --user-name "$user" --password "$password"

keyinfo="$(run aws iam create-access-key --user-name "$user" --output text)"

key_id="$(cut -f2 <<< "$keyinfo")"
secret_key="$(cut -f4 <<< "$keyinfo")"

account_alias="$(run aws iam list-account-aliases --output text | head -1 | cut -f2)"

info="
Sign in URL: https://$account_alias.signin.aws.amazon.com/console

Account nickname: $account_alias
Username: $user
Password: $password

Access key ID: $key_id
Secret access key: $secret_key
"

echo_blue "New account sign in info:"
sed 's/^/    /' <<< "$info"

echo

# Give user permissions
run aws iam add-user-to-group --user-name "$user" --group-name "$iam_group"

# Again insecure to put secrets in CLI args, but that's OK
run curl -sS --data-urlencode "content=$info" --data-urlencode 'action=multi' \
    -X POST https://onceler.app.cloud.gov/once/

echo_blue "This account can be deleted with interview-delete-iam-user"
