#!/bin/bash

set -euo pipefail

basename="$(basename "$0")"

BASEPATH="$(dirname "$0")"
. "${BASEPATH}/lib/common.sh"
. "${BASEPATH}/lib/sandbox-lib.sh"

# Try really hard not to let anything accidentally write to stdout.
# Point stdout at stderr and open FD 3 to point to the original stdout.
# Use echo >&3 to write to stdout hereafter.

exec 3>&1 1>&2

usage() {
    cat >&2 << EOM

Usage: $basename ENV_NAME

Disables auto-tf execution for the specified sandbox environment (defaults to \$GSA_USERNAME if not specified)

-h: Show this usage information
-v: Verify the current status of the pipeline
-r <string>: Add a custom reason for disabling auto-tf

Arguments:

    ENV_NAME:
    Environment name for the deployment, e.g. "dev", "prod", or "global".

EOM
}

man_page() {
    cat >&2 << EOM

Usage: $basename ENV_NAME

Disables auto-tf execution for the specified sandbox environment (defaults to \$GSA_USERNAME if not specified)

Arguments:

    ENV_NAME:
    Environment name for the deployment, e.g. "dev", "prod", or "global".

Options:

    -h              Display this message
    -v              Verify the current status of the pipeline
    -r <string>     Adds a custom reason for disabling auto-tf (This defaults to "Disabled via disable-autotf script by user \$GSA_USERNAME")
EOM
exit 0
}

1_verify_pipeline_status() {
    local isEnabled
    isEnabled=$(aws codepipeline get-pipeline-state \
        --name "auto_terraform_app_$TF_ENV" \
        | jq ".stageStates[1].inboundTransitionState.enabled")

    if $isEnabled
    then
        return
    else
        raise "Auto-tf is already disabled for envirnoment: $TF_ENV"
    fi
}

2_disable_pipeline() {
    aws codepipeline disable-stage-transition \
        --pipeline-name "auto_terraform_app_$TF_ENV" \
        --stage-name Plan --transition-type Inbound \
        --reason "$reason"

    exit 0
}

TASKS=(
    "1_verify_pipeline_status"
    "2_disable_pipeline"
)

TODO=()

reason="Disabled via disable-autotf script by user $GSA_USERNAME"

while getopts "r:vhe" opt; do
    case $opt in
        r) reason="$OPTARG" ;;
        v) TODO+=("${TASKS[0]}") ;;
        e) TODO+=("${TASKS[1]}") ;;
        h) man_page ;;
        *) usage && exit 1 ;;
    esac
done
shift $((OPTIND-1))

verify_root_repo
verify_private_repo
verify_sandbox_env "${1:-}"

run_tasks
