#!/bin/bash

# Create an IAM user's AWS Console login URLs!

set -eu

. "$(dirname "$0")/lib/common.sh"

usage() {
  cat >&2 <<EOM

Usage: $(basename "$0") [USER_NAME] (leave blank to get roles for your own user)

Look up AWS IAM roles that USER_NAME -- or one's self -- can Assume via aws-vault.
Verifies USER_NAME in \`aws iam list-users\` and terraform/master/global/users.yaml

If USER_NAME is provided:
- Must be run with an Assumed role from login-master, e.g. master-admin
- Will only print out list of Console URLs available to USER_NAME

EOM
}

[ $# -gt 1 ] && raise 'Must provide 0-1 arguments'
verify_root_repo
echo

declare {FOUND_POLICIES,ROLE_ARNS,RUN_AS_CONFIG,VERIFIED_USER}=
IAM_USER=${1-}
verify_iam_user "${IAM_USER}"

echo_cyan "Getting available Console URL(s) for user ${VERIFIED_USER}..."
echo
# verify that we have permission to see the groups for $VERIFIED_USER
for GROUP in $(aws iam list-groups-for-user \
                --user-name "${VERIFIED_USER}" \
                --query 'Groups[].{Group:GroupName}' \
                --output text) ; do
  FOUND_POLICIES+=$(aws iam list-attached-group-policies \
                    --group "${GROUP}" \
                    --query 'AttachedPolicies[].{Arn:PolicyArn}' \
                    --output text)
  FOUND_POLICIES+=" "
done

MASTER_FILE='terraform/master/global/main.tf'
# shellcheck disable=SC1003
ACCOUNT_TYPES=$(echo -e "{\n$(sed -E '1,/aws_account_types/d;/\}/,$d' ${MASTER_FILE})}" |
                sed -E 's/\]\}/\]\'$'\n\}/;s/ = /\: /g;s/ #.+$//g')
for POLICY in $(echo "${FOUND_POLICIES[@]}" |
                tr -s '[:blank:]' '\n' | sort -u | tr '\n' ' ') ; do
  ACCOUNT=$(echo "$POLICY" | sed -E 's/.*policy\/([a-zA-z]+)Assume.*/\1/')
  ROLE=$(echo "$POLICY" | sed -E 's/.*Assume//')
  SHORT_ROLE=$(grep -wlr "${ROLE}" terraform/all/module/iam-role-*.tf |
               sed -E 's/.*\-([a-z]+)\.tf/\1/')
  for ACCOUNT_ID in $(echo "$ACCOUNT_TYPES" | jq -r --arg ACCOUNT "$ACCOUNT" '.[$ACCOUNT][]') ; do
    SHORT_ACCT=$(grep -E "^\s+\"${ACCOUNT_ID}\"" "${MASTER_FILE}" |
      sed -E 's/.+login-([a-z-]+).*/\1/')
    ROLE_ARNS+=("${SHORT_ACCT}-${SHORT_ROLE}+arn:aws:iam::${ACCOUNT_ID}:role+${ROLE}")
    echo "https://signin.aws.amazon.com/switchrole?account=${ACCOUNT_ID}&roleName=${ROLE}&displayName=${SHORT_ACCT}-${SHORT_ROLE}"
  done
done



