#!/bin/bash

# Follow CodeBuild logs for AMI image builds

set -euo pipefail

. "$(dirname "$0")/lib/common.sh"

usage() {
  cat >&2 << EOM

Usage: ${0} -a AWS_ACCOUNT -t TYPE [-p PIPE_NAME]

Runs \`aws logs tail --follow --format short\` on the most recent stream
from the /aws/codebuild/login-\$PIPE_NAME-\$TYPE CloudWatch Log Group
in the login-\$AWS_ACCOUNT account.

Executed via \`aws-vault exec \$AWS_ACCOUNT-admin\`; requires FullAdministrator
role/access to be set in ~/.aws/config as a result.
\$PIPE_NAME defaults to 'image' if not specified.

EOM
}

declare {ACCOUNT,TYPE,AV_PROFILE}=
PIPE_NAME='image'

verify_root_repo
while getopts a:t:p:h opt
do
  case $opt in
    a) ACCOUNT="${OPTARG}"    ;;
    t) TYPE="${OPTARG}"       ;;
    p) PIPE_NAME="${OPTARG}"  ;;
    h) usage && exit 0        ;;
    *) raise 'Invalid option' ;;
  esac
done
shift $((OPTIND-1))

if [[ -z ${ACCOUNT} ]] ; then
  raise 'AWS account must be specified with -a flag'
fi
if ! [[ "${TYPE}" =~ (base|rails) ]] ; then
  raise "TYPE must be \`base\` or \`rails\`; specify with -t flag"
fi

get_iam 'imagebuild' "${ACCOUNT}" 'FullAdministrator'

echo_cyan "Finding newest build run for login-${PIPE_NAME}-${TYPE} CodeBuild project..."
BUILD_ID=$(ave aws codebuild list-builds-for-project \
  --project-name login-${PIPE_NAME}-${TYPE} --max-items 1 --query ids | jq -r '.[]')
echo_cyan "Verifying status of build run '${BUILD_ID}'..."
BUILD_STATUS=$(ave aws codebuild batch-get-builds --ids ${BUILD_ID} \
  --query 'builds[].buildStatus' | jq -r '.[]')
if [[ "${BUILD_STATUS}" != "IN_PROGRESS" ]] ; then
  echo_yellow "Status of ${BUILD_ID} is '${BUILD_STATUS}';"
  if ! prompt_yn "continue with log tailing operation?" ; then
    echo_green "Stopping."
    exit 0
  fi
fi

LOG_STREAM=$(echo ${BUILD_ID} | awk -F':' '{print $NF}')
echo_green "Following log stream ID '${LOG_STREAM}'; press CTRL-C to exit."
trap "echo && echo_green 'Finished following ${BUILD_ID} in login-${ACCOUNT}.'" INT
[[ ${PIPE_NAME} == 'image' ]] && PIPE_NAME=${ACCOUNT}
ave aws logs tail /aws/codebuild/login-us-west-2-${PIPE_NAME}-imagebuild-${TYPE} \
  --log-stream-names ${LOG_STREAM} --follow --format short
