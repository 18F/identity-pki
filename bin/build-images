#!/bin/bash

# Activate imagebuild pipelines + switch base-image branch if desired

set -euo pipefail

. "$(dirname "$0")/lib/common.sh"

usage() {
  cat >&2 << EOM

Usage: ${0} -a AWS_ACCOUNT [-b BRANCH|-t TYPE]

Runs \`aws codepipeline start-pipeline-execution\` for
each type of AMI in the login-\$AWS_ACCOUNT account.

Flags:

  -b BRANCH : Update the identity-base-image branch
              used for builds to \$BRANCH, via tf-deploy
              and aws cloudformation
  -t TYPE   : Only update the stacks/build project/
              pipeline for \$TYPE AMIs (base/rails)
  -h        : Display this help

EOM
}

get_build_branch() {
  echo -e "\nVerifying current imagebuild branch in \`login-${ACCOUNT}\`..."
  CURRENT_BRANCH=$(ave -r aws ssm get-parameter \
    --name ImageCreationSourceFile --output text --with-decryption --query 'Parameter.Value' |
    sed -E 's/18F\/identity-base-image\/([A-Za-z0-9\/-]+)\/18F_identity-base-image\.zip/\1/')
  echo_cyan "- Branch: ${CURRENT_BRANCH}"
  echo
}

run_terraform() {
  $(dirname "$0")/td -d imagebuild -e ${ACCOUNT} -at ${TF_APPLY_CMD}
  if ! [[ ${?} == 0 ]] ; then
    raise "Terraform deploy failed; investigate!"
  fi
}

update_build_branch() {
  local STACKS=()
  echo -e "Ready to update imagebuild/${ACCOUNT} via tf-deploy."
  if [[ ${CURRENT_BRANCH} == ${BUILD_BRANCH} ]] ; then
    echo_yellow "NOTE: Current imagebuild branch already set to \`${BUILD_BRANCH}\`;"
    echo_yellow "will NOT run update-stack operations after apply is complete."
  else
    echo_cyan "- Desired branch: ${BUILD_BRANCH}"
  fi
  echo
  if prompt_yn "Continue?" ; then
    TF_APPLY_CMD="var 'code_branch=${BUILD_BRANCH}'"
    run_terraform
    if ! [[ ${CURRENT_BRANCH} == ${BUILD_BRANCH} ]] ; then
      echo
      echo_green "\`ImageCreationSourceFile\` parameter in \`login-${ACCOUNT}\` updated to \`${BUILD_BRANCH}\`."
      echo "Updating CloudFormation stacks to pull in new parameter value; StackIDs specified below."
      for TYPE in ${TYPE_LIST} ; do
        STACKS+=$(ave -r aws cloudformation list-stacks |
                        jq -r '.StackSummaries[]|select(.StackStatus == "DELETE_COMPLETE"|not).StackName' |
                        grep -i ${TYPE}Role | tr '\n' ' ')
      done
      for STACK in ${STACKS} ; do
        STACK_PARAMS=$(ave -r aws cloudformation describe-stacks \
                        --stack-name ${STACK} \
                        --query 'Stacks[].Parameters[].ParameterKey' \
                        --output text)                 
        PARAM_ARG=$(for PARAM in $(echo "${STACK_PARAMS}" | tr -s '\t' ' '); do
                      echo "ParameterKey=$PARAM,UsePreviousValue=true"
                    done | tr '\n' ' ')
        ave -r aws cloudformation update-stack \
          --stack-name ${STACK} \
          --use-previous-template \
          --capabilities CAPABILITY_IAM \
          --parameters ${PARAM_ARG} --output text
      done
      echo -e "\nWaiting for stack updates to complete..."
      for STACK in ${STACKS} ; do
        ave aws cloudformation wait stack-update-complete --stack-name ${STACK}
      done
      echo_green "CloudFormation stacks updated."
    fi
  fi
}

declare {ACCOUNT,BUILD_BRANCH,TF_APPLY_CMD,CURRENT_BRANCH,AV_PROFILE}=
TYPE_LIST='base rails'

verify_root_repo
while getopts :a:t:b:h opt
do
  case $opt in
    a) ACCOUNT="${OPTARG}"      ;;
    t) TYPE_LIST="${OPTARG}"    ;;
    b) BUILD_BRANCH="${OPTARG}" ;;
    h) usage && exit 0          ;;
    *) raise 'Invalid option'   ;;
  esac
done
shift $((OPTIND-1))

if [[ -z ${ACCOUNT} ]] ; then
  raise 'AWS account must be specified with -a flag'
elif ! [[ "${TYPE_LIST}" =~ (base|rails) ]] ; then
  raise "TYPE must be \`base\` or \`rails\`; remove -t flag to use both"
fi

get_iam 'imagebuild' "${ACCOUNT}"
get_build_branch

if ! [[ -z ${BUILD_BRANCH} ]] ; then
  update_build_branch
else
  if [[ ${CURRENT_BRANCH} != 'main' ]] ; then
    echo_yellow "Current imagebuild branch is \`${CURRENT_BRANCH}\`, not \`main\`;" 
    echo_yellow "additionally, no custom branch was specified via -b flag."
    echo
    if prompt_yn "Update imagebuild/${ACCOUNT} to use \`main\` branch instead?" ; then
      echo
      BUILD_BRANCH='main'
      update_build_branch
    else
      echo_green "Continuing with imagebuild branch \`${CURRENT_BRANCH}\`."
    fi
  fi
fi

echo -e "\nReady to build new AMI(s) for:"
for TYPE in ${TYPE_LIST} ; do
  echo_cyan "- ${ACCOUNT}-${TYPE}"
done
echo
if prompt_yn "Continue?" ; then
  for TYPE in ${TYPE_LIST} ; do
    PIPELINE=$(ave -r aws codepipeline list-pipelines |
                    jq -r '.pipelines[].name' | grep -i ${TYPE})
    ave aws codepipeline start-pipeline-execution --name ${PIPELINE} >/dev/null
  done
  echo_green "Pipeline execution(s) started in \`login-${ACCOUNT}\`!"
  echo "Check the AWS CodePipeline/CodeBuild console for build progress."
  echo
fi
