#!/bin/bash

# Activate imagebuild pipelines + switch base-image branch if desired

set -euo pipefail

. "$(dirname "$0")/lib/common.sh"

usage() {
  cat >&2 << EOM

Usage: ${0} -a AWS_ACCOUNT [-b BRANCH|-t TYPE|-v]

Runs \`aws codepipeline start-pipeline-execution\` for
each type of AMI in the login-\$AWS_ACCOUNT account.

Flags:

  -a Account : Which Account to build Images in
  -t TYPE    : Only update stacks/build project/pipeline for \$TYPE AMIs (base/rails)
  -v         : Only verify branch in \`login-\$ACCOUNT\`; do not update/build
  -h         : Display this help

EOM
}

declare {ACCOUNT,BUILD_BRANCH,CURRENT_BRANCH,AV_PROFILE,VERIFY_ONLY}=
TYPE_LIST=('base' 'rails')

verify_root_repo
while getopts :a:t:b:vh opt
do
  case $opt in
    a) ACCOUNT="${OPTARG}"      ;;
    t) TYPE_LIST=("${OPTARG}")  ;;
    v) VERIFY_ONLY=true         ;;
    h) usage && exit 0          ;;
    *) raise 'Invalid option'   ;;
  esac
done
shift $((OPTIND-1))

if [[ -z ${ACCOUNT} ]] ; then
  raise 'AWS account must be specified with -a flag'
fi
if ! [[ "${TYPE_LIST[@]}" =~ (base|rails) ]] ; then
  raise "TYPE must be \`base\` or \`rails\`; remove -t flag to use both"
fi

get_iam 'imagebuild' "${ACCOUNT}" 'FullAdministrator'

echo -e "\nReady to build new AMI(s) for:"
for TYPE in "${TYPE_LIST[@]}" ; do
  echo_cyan "- ${ACCOUNT}-${TYPE}"
done
echo
if prompt_yn "Continue?" ; then
  for TYPE in "${TYPE_LIST[@]}" ; do
    PIPELINE=$(ave -r aws codepipeline list-pipelines | jq -r '.pipelines[].name' |
                grep -i "CodePipeline-Image${TYPE}Role-CodePipeline" | head -n1)
    ave aws codepipeline start-pipeline-execution --name ${PIPELINE} >/dev/null
  done
  echo_green "Pipeline execution(s) started in \`login-${ACCOUNT}\`!"
  echo "Check the AWS CodePipeline/CodeBuild console for build progress."
  echo "You can also use bin/follow-images to follow the logs in CloudWatch!"
fi
echo
