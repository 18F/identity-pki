#!/bin/bash

#### Update Terraform provider plugins (and Terraform itself, if desired) ####

trap revert_versions EXIT

set -euo pipefail

. "$(dirname "$0")/lib/common.sh"

usage() {
    cat >&2 << EOM

Usage: ${0} [-t|-h] [PROVIDER1 PROVIDER2 ...]
  - If provided, will only update the providers whose names are specified as arguments
    (e.g. 'hashicorp/aws', 'integrations/github', etc.) rather than the full list.

Flags:
  -t : Skip checking to see if an update to Terraform is available
  -h : Display help

EOM
}

help_me() {
    cat >&2 << EOM

Updates all providers found in versions.tf via 'terraform providers lock', updating
that file and .terraform.lock.hcl for the full repo. Creates a new lockfile within
terraform/master/global and replaces the repo-wide lockfile with the newly-created one.

Will also check to see if the currently-running version of Terraform is the most
up-to-date, and (upon approval) will run terraform-switch.sh, update the
required_version in versions.tf, and add the new version to the KNOWN_TF_VERSIONS
variable in bin/lib/common.sh as well.
EOM
  usage
  exit 0
}

# revert .bakfiles if they exist
revert_versions() {
  for TFP_FILE in 'versions.tf' '.terraform.lock.hcl' ; do
    if [[ -f "${GIT_DIR}/${TFP_FILE}.bak" ]] ; then
      mv "${GIT_DIR}/${TFP_FILE}.bak" "${GIT_DIR}/${TFP_FILE}"
    fi
  done
}

# echo and remove escaping slash(es)
dsl() {
  echo $@ | tr -d '\'
}

# check, verify and update TF variables
check_tf_versions() {
  local TF_VERSION_INFO=$(terraform --version)
  local CURRENT_TF_VERSION=$(echo "${TF_VERSION_INFO}" | head -n 1 |
    awk '{print $2}' | sed -E 's/\.$//;s/\./\\\./g' | tr -d 'v')
  if [[ $(echo "${TF_VERSION_INFO}" | grep 'out of date!') ]] ; then
    NEW_TF_VERSION=$(echo "${TF_VERSION_INFO}" |
      tail -n-1 | awk '{print $2}' | sed -E 's/\.$//;s/\./\\\./g')
  fi
  REQUIRED_TF_VERSION=$(cat "${GIT_DIR}/versions.tf" | grep 'required_version' |
    awk -F'"' '{print $2}' | sed -E 's/\.$//;s/\./\\\./g')

  if [[ "$(dsl $CURRENT_TF_VERSION)" != "$(dsl $REQUIRED_TF_VERSION)" ]] ; then
    echo_yellow "Current Terraform version is $(dsl ${CURRENT_TF_VERSION});"
    echo_yellow "however, versions.tf requires $(dsl ${REQUIRED_TF_VERSION}) instead."
    if prompt_yn "Change current version via terraform-switch?" ; then
      run $(dirname "$0")/terraform-switch.sh $(dsl ${REQUIRED_TF_VERSION})
    else
      raise "Change currently-running Terraform version and try again!"
    fi
  fi
}

# providers lock for all platforms
tf_providers_lock() {
  local VERSIONS=${1:-}
  echo_green "Regenerating and copying lockfile..."
  cd "${LOCKFILE_DIR}"
  [[ -f "${LOCKFILE}" ]] && rm "${LOCKFILE}"
  cp "${GIT_DIR_LOCKFILE}" "${LOCKFILE}"
  if [[ ${VERSIONS} == 'NEW' ]] ; then
    ${GIT_DIR}/bin/awsv master terraform init -backend-config=bucket=login-gov.tf-state.340731855345-us-west-2 \
      -backend-config=key=terraform-master/global.tfstate \
      -backend-config=dynamodb_table=terraform_locks -backend-config=region=us-west-2 \
      -upgrade
  fi
  run terraform providers lock \
    -platform=windows_amd64 -platform=darwin_amd64 -platform=linux_amd64 \
    -platform=darwin_arm64 -platform=linux_arm64
  mv "${LOCKFILE}" "${GIT_DIR_LOCKFILE}"
  cd - >/dev/null
}

verify_root_repo
declare {SKIP_TF_UPDATE,NEW_TF_VERSION,OLD_VERSION,NEW_VERSION}
TF_UPDATED=false
FILES_UPDATED=false
PROVIDER_LIST=()
NEW_IN_LOCKFILE=()
LOCKFILE_DIR="${GIT_DIR}/terraform/master/global"
GIT_DIR_LOCKFILE="${GIT_DIR}/.terraform.lock.hcl"
LOCKFILE="${LOCKFILE_DIR}/.terraform.lock.hcl"
UPDATED_PROVIDERS=0
ALL_PROVIDERS=$(egrep 'source += +"' "${GIT_DIR}/versions.tf" | awk -F'"' '{print $2}')

while getopts th opt
do
  case $opt in
    t) SKIP_TF_UPDATE=true ;;
    h) help_me             ;;
    *) usage && exit 1     ;;
  esac
done
shift $((OPTIND-1))

for TFP_FILE in 'versions.tf' '.terraform.lock.hcl' ; do
  if [[ -f "${GIT_DIR}/${TFP_FILE}.bak" ]] ; then
    rm "${GIT_DIR}/${TFP_FILE}.bak"
  fi
  cp "${GIT_DIR}/${TFP_FILE}" "${GIT_DIR}/${TFP_FILE}.bak"
done

# all providers passed in as arguments must exist in versions.tf
if ! [[ -z "$@" ]] ; then
  for PROVIDER in "$@" ; do
    if [[ ! $(echo "${ALL_PROVIDERS[@]}" | grep $PROVIDER) ]] ; then
      raise "Provider ${PROVIDER} not found in versions.tf file!"
    else
      PROVIDER_LIST+=($(echo "${PROVIDER}" | sed -E 's/\//\\\//g'))
    fi
  done
else
  PROVIDER_LIST=($(echo "${ALL_PROVIDERS[@]}" | sed -E 's/\//\\\//g'))
fi

echo_green "Will check and attempt to update the following providers:"
for PROVIDER in "${PROVIDER_LIST[@]:-}" ; do
  echo "- $(dsl ${PROVIDER})"
  sed -i '' -E "/$PROVIDER/{n;s/( version = \")/\1\>\= /;}" "${GIT_DIR}/versions.tf"
done
echo

# find new provider versions from registry and update version.tf values,
echo_green "Finding new provider versions..."
for PROVIDER in "${PROVIDER_LIST[@]}" ; do
  OLD_VERSION=$(grep -A1 "source  = \"${PROVIDER}\"" "${GIT_DIR}/versions.tf" |
    tail -n+2 | sed -E 's/.+\"\>\= ([0-9\.]+)\"/\1/;s/\./\\\./g')
  NEW_VERSION=$(curl -s "https://registry.terraform.io/v1/providers/$(dsl ${PROVIDER})" |
    jq -r  '.versions[]' | tail -n 1 | sed -E 's/.+\"([0-9\.]+)\"/\1/;s/\./\\\./g')
  if [[ "${OLD_VERSION}" == "${NEW_VERSION}" ]] ; then
    echo_yellow "$(dsl ${PROVIDER}) is already at $(dsl ${NEW_VERSION}); skipping."
  else
    sed -i '' -E "/$PROVIDER/{n;s/$OLD_VERSION+/$NEW_VERSION/;}" "${GIT_DIR}/versions.tf"
    echo_cyan "Will update $(dsl ${PROVIDER}) from $(dsl ${OLD_VERSION}) to $(dsl ${NEW_VERSION})"
    ((UPDATED_PROVIDERS++))
    FILES_UPDATED=true
  fi
done

if [[ ${UPDATED_PROVIDERS} -gt 0 ]] ; then
  echo_cyan "${UPDATED_PROVIDERS} provider(s) updated in versions.tf" && echo
fi

tf_providers_lock 'NEW'
NEW_IN_LOCKFILE=($(diff --normal <(grep 'provider' "${GIT_DIR_LOCKFILE}.bak" | sort) \
                                <(grep 'provider' "${GIT_DIR_LOCKFILE}" | sort) |
                                egrep '^[<>]' |
                                awk -F'/|"' '{print $(NF-2)"/"$(NF-1)}')) || true
if [[ "${#NEW_IN_LOCKFILE[@]}" -gt 0 ]] ; then
  FILES_UPDATED=true
  echo_cyan "Providers added to lockfile:"
  echo_cyan "${NEW_IN_LOCKFILE[@]/#/$'\n'- }" && echo
fi

# switch >= back to = in versions.tf and re-run tf_providers_lock
for PROVIDER in "${PROVIDER_LIST[@]}" ; do
  sed -i '' -E "/$PROVIDER/{n;s/>= ([0-9\.]+)/\1/;}" "${GIT_DIR}/versions.tf"
done
tf_providers_lock

# check for new TF version if -t was not set
check_tf_versions
if [[ -z ${SKIP_TF_UPDATE} ]] && [[ ! -z ${NEW_TF_VERSION} ]]; then
  if prompt_yn "New Terraform version $(dsl ${NEW_TF_VERSION}) available; update?" ; then
    cp "${GIT_DIR}/versions.tf" "${GIT_DIR}/versions.tf.bak"
    run $(dirname "$0")/terraform-switch.sh $(dsl ${NEW_TF_VERSION})
    sed -i '' -E "s/(required_version = \")[0-9\.]+/\1${NEW_TF_VERSION}/" \
      "${GIT_DIR}/versions.tf"
    rm "${GIT_DIR}/versions.tf.bak"
    echo_green "Updated required_version in versions.tf to $(dsl ${NEW_TF_VERSION})"
    if ! [[ $(echo ${KNOWN_TF_VERSIONS[@]} | grep $(dsl ${NEW_TF_VERSION})) ]] ; then
      sed -i '' -E "s/(KNOWN_TF_VERSIONS=\()/\1\n  \"v${NEW_TF_VERSION}\"/" \
        $(dirname "$0")/lib/common.sh
      echo_green "Added v$(dsl ${NEW_TF_VERSION}) to KNOWN_TF_VERSIONS in common.sh"
    fi
    TF_UPDATED=true
  fi
fi

# verify schema and restore symlink
if [[ ${FILES_UPDATED} == true ]] || [[ ${TF_UPDATED} == true ]] ; then
  echo_green "Verifying new configuration with bin/tf-deploy..."
  PROVIDERS_SCHEMA=$($(dirname "$0")/td -d master -v schema -json) || true
  if [[ -z ${PROVIDERS_SCHEMA} ]] ; then
    raise "Command failed, verify configs and run again!"
  else
    echo && echo_cyan "Configuration valid! Providers found:"
    echo "${PROVIDERS_SCHEMA}" | jq '.provider_schemas|keys'
    echo
  fi
fi

# remove .bak files that still exist
for TFP_FILE in 'versions.tf' '.terraform.lock.hcl' ; do
  if [[ -f "${GIT_DIR}/${TFP_FILE}.bak" ]] ; then
    rm "${GIT_DIR}/${TFP_FILE}.bak"
  fi
done
