#!/bin/bash
. "$(dirname "$0")/.subfunctions"

############# login.gov aliases/functions #############
if [[ ! $(brew list --cask | grep aws-vault) ]] ; then
  brew cask install aws-vault || { echo "aws-vault not installed!" && break 1 ; }
fi

######## aliases ########
alias bb="git checkout stages/${GSA_USERNAME}"
alias laptop='bash <(curl -s https://raw.githubusercontent.com/18F/laptop/master/laptop)'
alias ac='aws-vault clear'
alias al='aws-vault list'

#### fast aws-vault commands ####
av() {
  read -r -d '' usage <<'EOF'
TBD
EOF
  [[ $# == 0 ]] && badopt
  while getopts i:l:s:p:a:t:o:m:x: opt
  do
    case "${opt}" in
      i) AV_PROFILE='sandbox-admin'         ;;
      l) AV_PROFILE='prod-admin'            ;;
      s) AV_PROFILE='sms-sandbox-admin'     ;;
      p) AV_PROFILE='sms-prod-admin'        ;;
      a) AV_PROFILE='alpha-admin'           ;;
      t) AV_PROFILE='tooling-sandbox-admin' ;;
      o) AV_PROFILE='tooling-prod-admin'    ;;
      m) AV_PROFILE='master-admin'          ;;
      x) AV_PROFILE='x' && shift 1          ;;
      h|*) badopt ;;
    esac
    AV_CMD="${OPTARG}" 
  done
  if [[ ${AV_PROFILE} == 'x' ]] ; then
    AV_PROFILE="${1}"
  fi
  shift
  case "${AV_CMD}" in
    v) run aws-vault exec ${AV_PROFILE} --no-session --duration "${1:-1}h" ;;
    l) run aws-vault login ${AV_PROFILE} --stdout |
        sed -E "s/%2Fconsole%2F/%2F${1:-console}%2F/" |
        xargs -t /Applications/Google\ Chrome.app/Contents/MacOS/Google\ Chrome 2>/dev/null
    ;;
    c) run_av "$@" ;;
    *) badopt ;;
  esac
}

#### quickly run common cloudlib aliases/commands with any AWS_PROFILE/env ####
vcl() {
  read -r -d '' usage <<'EOF'

TBD
 
EOF
  [[ $# == 0 ]] && badopt
  local CL_TABLE EC2_TYPE EC2_ACCT
  local AV_REGION='us-west-2'
  if [[ ${1} == 'ue1' ]] ; then
    AV_REGION='us-east-1'
    shift 1
  fi
  local EC2_ENV="${2}"
  case ${EC2_ENV} in
    gitlab-production) EC2_ACCT="tooling-prod"    ;;
    gitlab-*)          EC2_ACCT="tooling-sandbox" ;;
    staging|dm|prod)   EC2_ACCT="prod"            ;;
    *)                 EC2_ACCT="sandbox"         ;;
  esac
  AV_PROFILE="${EC2_ACCT}-admin"
  EC2_ENV=${EC2_ENV#*-}
  [[ -z ${EC2_ENV:-} ]] && EC2_ENV=${GSA_USERNAME}
  while getopts el:c:r:s:L:S:F:D: opt
  do
    case "${OPTARG}" in
      A) EC2_TYPE='ALL'                ;;
      a) EC2_TYPE='app'                ;;
      i) EC2_TYPE='idp'                ;;
      j) EC2_TYPE='jumphost'           ;;
      m) EC2_TYPE='migration'          ;;
      o) EC2_TYPE='outboundproxy'      ;;
      p) EC2_TYPE='pivcac'             ;;
      w) EC2_TYPE='worker'             ;;
      G) EC2_TYPE='gitlab'             ;;
      B) EC2_TYPE='gitlab-build-pool'  ;;
      T) EC2_TYPE='gitlab-test-pool'   ;;
      D) EC2_TYPE='gitlab-deploy-pool' ;;
      *) [[ ${opt} =~ 'e' ]] || badopt ${1} ;;
    esac
    case "${opt}" in
      e) CL_TABLE=$(run_av ls-servers -Hlqe ${EC2_ENV} -R ${AV_REGION})                     ;;
      l) CL_TABLE=$(run_av ls-servers -Hlqn asg-${EC2_ENV}-${EC2_TYPE} -R ${AV_REGION})     ;;
      c) run_av scale-in-old-instances -qf ${EC2_ENV} ${EC2_TYPE} -R ${AV_REGION}           ;;
      r) run_av asg-recycle -q ${EC2_ENV} ${EC2_TYPE} -R ${AV_REGION}                       ;;
      s) run_av asg-size -q ${EC2_ENV} ${EC2_TYPE} ${3-} -R ${AV_REGION}                    ;;
      L) run_av ssm-instance -R ${AV_REGION} --newest asg-${EC2_ENV}-${EC2_TYPE}            ;;
      S) run_av ssm-instance -R ${AV_REGION} -d sudo --newest asg-${EC2_ENV}-${EC2_TYPE}    ;;
      F) run_av ssm-instance -R ${AV_REGION} -d tail-cw --newest asg-${EC2_ENV}-${EC2_TYPE} ;;
      D) run_av ssm-instance -R ${AV_REGION} -d ${3-} --newest asg-${EC2_ENV}-${EC2_TYPE}   ;;
      *) badopt ${opt} ;;
    esac
  done
  [[ -z "${CL_TABLE}" ]] || echo "${CL_TABLE}" |
                            sed '1d;$d;s/\|/ /g;s/asg\-//g' |
                            awk '{print $1, $2, $3, $4, $6, $12}' |
                            column -t
}

### get secrets bucket ###
get_secrets() {
  PROFILE=${1}
  GIT_DIR=$(git rev-parse --show-toplevel)
  if [ "$(echo ${GIT_DIR} | awk -F/ '{print $NF}')" != 'identity-devops' ]
  then
    echo "Must run in identity-devops"
    false
  else
    ACCOUNT=$(grep "# login-${PROFILE}" "${GIT_DIR}/terraform/master/global/main.tf" |
              sed -E 's/^.*\"([0-9]+)\".*$/\1/')
    echo "s3://login-gov.secrets.${ACCOUNT}-us-west-2/"
  fi
}
