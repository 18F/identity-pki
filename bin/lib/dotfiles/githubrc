#!/bin/bash

############### github aliases/functions ###############
if [[ ! $(brew list | grep hub) ]] ; then
  brew install hub || { echo "hub not installed!" && exit 1 ; }
fi

######## aliases ########
alias gs="run git status"
alias gl="run git log --pretty=oneline --no-abbrev-commit -n 10"
alias gpom="run git pull origin master"
alias gom="run git checkout master && gpom"
alias bc="git rev-parse HEAD | tr -d '\n' | pbcopy"
alias gil="run open https://github.com/issues/assigned"
alias gbi="run open https://github.com/orgs/18F/projects/5?card_filter_query=assignee%3A${GSA_USERNAME}"
alias gpl="run hub pr list"
alias gi="run hub issue"

######## functions ########
USE_RUN=1
run() {
  if [[ $USE_RUN -gt 0 ]] ; then
    if [ -t 1 ]; then
      echo -ne "\\033[1;36m"
    fi

    echo >&2 "+ $*"

    if [ -t 1 ]; then
      echo -ne '\033[m'
    fi
  fi
  "$@"
}

#### get list of GH_REVS per the repo ####
gh_revs() {
  GH_REVS=$(cat ~/.login-revs |
    grep "$(basename $(git rev-parse --show-toplevel))" |
    awk '{print $2}')
  [[ -z ${GH_REVS} ]] && GH_REVS="${LOGIN_REVS}-"
}

#### cd to ${GITHUB_PARENT_DIR}/identity-${1} ####
gid() {
  run cd "${GITHUB_PARENT_DIR}/identity-${1}"
}

#### create/checkout new git branch named ${1} ####
newb() {
  gom
  run git checkout -b "${1}"
}

#### open specified PR in browser
gps() {
  run hub pr show "${1}"
}

#### open specified issue in browser
gio() {
  local repo=$(git remote get-url --all origin | sed -E 's/.*:(.*)\..*/\1/')
  run open "https://github.com/${repo}/issues/${1}"
}

#### add files, commit w/message, push to origin with set-upstream ####
gpb() {
  run git add --all
  run git commit -m "$@"
  run git push --set-upstream origin $(git_current_branch)
}

#### delete either current branch or branch name = ${1}; end on master ####
delb() {
  local branch=$1
  [ -z ${1} ] && branch=$(git_current_branch)
  gom
  run git branch -d $branch
}

#### merge/close PR, delete current/specified branch unless -n is set ####
gmpr () {
  local branch=$(git_current_branch)
  local save_branch=false
  if [[ "${branch}" == 'master' ]] ; then
    echo "Cannot be run from master branch!"
    break 1
  fi
  while getopts n opt ; do
    case "${opt}" in
      n) save_branch=true ;;
    esac
  done
  run git checkout master && \
  run git pull origin master && \
  run git checkout $branch && \
  run git rebase master && \
  run git push --force-with-lease && \
  run git merge master --no-edit && \
  run git checkout master && \
  run git merge --no-edit --no-ff $branch && \
  run git push origin master
  [[ "${save_branch}" == 'true' ]] || delb $branch
}

#### add>commit>push -u>open PR with $msg ####
gpr() {
  gh_revs
  local msg=("${@}")
  gpb "${msg[@]}"
  run hub pull-request -p -r "${GH_REVS}" -m "${msg[@]}" -e
}

#### create issues ####
ghi() {
  local ASSIGNEE
  local TEMPLATE="feature_request"
  while getopts a:bon opt ; do
    case "${opt}" in
      a) ASSIGNEE="-a ${OPTARG}" ;;
      b) TEMPLATE="bug_report" ;;
      o) TEMPLATE="offboard-devops" ;;
      n) TEMPLATE="onboarding-devops" ;;
      *) badopt ;;
    esac
  done
  run hub issue create --edit "${ASSIGNEE}" \
    -F "${GITHUB_PARENT_DIR}/identity-devops/.github/ISSUE_TEMPLATE/${TEMPLATE}.md"
}

#### pull branch up to current version ####
grff() {
  if [[ $(cat VERSION.txt | grep 'pre-') ]] ; then
    echo "Must be run from an appropriate stages/ branch"
  else
    git pull --ff-only origin v$(($(cat VERSION.txt)+1))
  fi
}

#### create private gist from clipboard ####
ggc() {
  local file="${1}"
  local desc=("${@:2}")
  run gist -oPp -d "${desc[@]}" -f ${file}
}

#### determine active version / next / previous, and get PRs ####
gv() {
  NEW_RELEASE=${1:-$(cat VERSION.txt | sed -E 's/pre\-//')}
  OLD_RELEASE=$(($(echo ${NEW_RELEASE} | sed -E 's/\..+//')-1))
  run_var PR_LIST hub pr list -b master -s merged -o updated -L 100 -f "- %i %t%n"
  if [[ $(echo "${PR_LIST}" | grep "${NEW_RELEASE}") ]] ; then
    RELEASE_PRS=$(echo "${PR_LIST}" |
      sed -n "/${NEW_RELEASE}/,/${OLD_RELEASE}/p;/${OLD_RELEASE}/q;" |
      grep -v "${NEW_RELEASE}\|${OLD_RELEASE}") 
  else
    RELEASE_PRS=$(echo "${PR_LIST}" |
      sed "/${OLD_RELEASE}/q" |
      grep -v "$NEW_RELEASE\|$OLD_RELEASE")
  fi
}

#### create a GitHub release ####
ghr() {
  local PR_LIST
  gv
  run hub release create "v${NEW_RELEASE}" -m "$(cat <<EOF
Release v${NEW_RELEASE}

${RELEASE_PRS}
EOF
  )"
}

#### create a release PR ####
grpr() {
  local PR_LIST GIT_TAGS
  gv
  gh_revs
  run git checkout master && \
  run git pull origin master && \
  run git checkout -b release/v${NEW_RELEASE}
  run rake release && \
  run git push origin release/v${NEW_RELEASE}
  run git push --tags && \
  run hub pull-request -p -r "${GH_REVS}" -e -m "$(cat <<EOF
Release v${VERSION}

${RELEASE_PRS}
EOF
  )"
}

#### create git hotfix PR ####
ghf() {
  gv
  local HF_VERSION=$(echo ${NEW_RELEASE} | awk -F. '{print $1}')
  local HF_COUNT=$(echo ${NEW_RELEASE} | awk -F. '{print $2}')
  [[ -z ${HF_COUNT} ]] && HF_COUNT=0
  HF_NUM=$((${HF_COUNT}+1))
  echo "${HF_VERSION}.${HF_NUM}" > VERSION.txt
  grpr
}

