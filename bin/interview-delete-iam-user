#!/bin/bash
set -euo pipefail

# shellcheck source=/dev/null
. "$(dirname "$0")/lib/common.sh"

usage() {
    cat >&2 <<EOM
usage: $(basename "$0") USERNAME [AWS_PROFILE]

Delete an IAM user for a Login.gov interviewee in the Login.gov interview
account.
EOM
}

if [ $# -lt 2 ]; then
    usage
    exit 1
fi

user="$1"

AWS_PROFILE="${2-identity-interviews}"
export AWS_PROFILE

echo "AWS_PROFILE: $AWS_PROFILE"

echo_blue "Deleting account for $user in $AWS_PROFILE"

run aws iam get-user --user-name "$user"

if run aws iam get-login-profile --user-name "$user"; then
    run aws iam delete-login-profile --user-name "$user"
fi

for key_id in \
    $(run aws iam list-access-keys --user-name "$user" --output text | cut -f2)
do
    run aws iam delete-access-key --user-name "$user" --access-key-id "$key_id"
done

run aws iam delete-user --user-name "$user"

echo_blue "Done deleting $user"
