# cloud-config

# This file is an ERB template.

# This is boilerplate cloud init config to run provision.sh with the specified
# arguments.  provision.sh handles cloning a git repository and running
# chef-client on it locally.
runcmd:
- /var/lib/cloud/instance/scripts/provision.sh <%= "--kitchen-subdir #{kitchen_subdir}" if defined?(kitchen_subdir) %> <%= "--berksfile-toplevel" if defined?(berksfile_toplevel) %> --asg-name "<%= asg_name %>" --lifecycle-hook-name "<%= lifecycle_hook_name %>" --git-ref "<%= git_ref %>" "<%= s3_ssh_key_url %>" "<%= git_clone_url %>"
- touch "/run/<%= provision_phase_name %>"
<% if defined?(run_aide) && run_aide -%>
- "aideinit --force --yes && touch /var/tmp/ran-aideinit"
<% end -%>

# merge multipart cloud-init files in a sane way
merge_type: 'list(append)+dict(recurse_array)+str()'
