---
database/idp-postgresql-unusual-messages:
  logs:
    - /aws/rds/cluster/login-${env}-idp-aurora-${region}/postgresql
  query: |
    ## Look for unusual messages in PostgreSQL logs
    filter @message not like /DETAIL:/
    | filter @message not like /STATEMENT:\s+INSERT/
    | filter @message not like /ERROR:\s+duplicate/
    | filter @message not like /LOG:\s+(checkpoint|duration|recovery|restartpoint)/

database/slow-queries/idp-postgresql-slow-queries:
  logs:
    - /aws/rds/cluster/login-${env}-idp-aurora-${region}/postgresql
  query: |
    # Parse logs and search for slow queries
    parse @message "* * *:*(*):*:*:*" as date, time, tz, remote_host, remote_host_port, user, process, logs
    | parse logs "duration:* ms*" as query_duration_ms, statement
    | filter @message like 'duration'
    | display date, time, remote_host, query_duration_ms, statement

database/slow-queries/idp-postgresql-slow-queries-avg-max:
  logs:
    - /aws/rds/cluster/login-${env}-idp-aurora-${region}/postgresql
  query: |
    # Parse logs and search for slow queries. Show average duration and max duration per minute
    parse @message "* * *:*(*):*:*:*" as date, time, tz, remote_host, remote_host_port, user, process, logs
    | parse logs "duration:* ms*" as query_duration_ms, statement
    | stats max(query_duration_ms) as max_query_duration, avg(query_duration_ms) as avg_query_duration by bin(1m) as timestamp
    | sort timestamp desc

database/slow-queries/idp-postgresql-sharelock-waits:
  logs:
    - /aws/rds/cluster/login-${env}-idp-aurora-${region}/postgresql
  query: |
    # Find all waits for ShareLocks
    parse @message "* * *:*(*):*:*:*" as date, time, tz, remote_host, remote_host_port, user, process, logs
    | parse logs "LOG:  process * * ShareLock on transaction * after * ms" as lock_process, action, transaction_id, lock_duration_ms
    | filter @message like 'ShareLock'
    | display @timestamp, lock_process, action, transaction_id, lock_duration_ms

nginx/errors-by-source:
  logs:
    - ${env}_/var/log/nginx/access.log
  query: |
    ## Find errors in NGINX webserver logs for all types
    filter status like /^5/
    #
    ## Only look in idp logs
    # | filter @logStream like /^idp/
    ## Only look in pivcac logs
    # | filter @logStream like /^pivcac/
    #
    ## Group by status, path, and source IP
    # | stats count() as count by status, uri_path, src
    ## Or just by source IP
    # | stats count() as count by src
    #
    | sort count desc
nginx/requests-by-ip-path:
  logs:
    - ${env}_/var/log/nginx/access.log
  query: |
    ## Find requests in NGINX webserver logs for idp instances
    fields @timestamp, @message
    #
    ## Only look in idp logs
    | filter @logStream like /^idp/
    ## Only look in pivcac logs
    # | filter @logStream like /^pivcac/
    #
    ## Group by source IP and path (status may also be helpful)
    | stats count() as count by src, uri_path
    #
    | sort count desc
nginx/requests-by-ip:
  logs:
    - ${env}_/var/log/nginx/access.log
  query: |
    ## Find requests in NGINX webserver logs for idp instances
    fields @timestamp, @message
    #
    ## Only look in idp logs
    | filter @logStream like /^idp/
    ## Only look in pivcac logs
    # | filter @logStream like /^pivcac/
    #
    ## Group by source IP and path (status may also be helpful)
    | stats count() as count by src
    #
    | sort count desc

outboundproxy/allowed-requests-by-destination:
  logs:
    - ${env}_/var/log/squid/access.log
  query: |
    ## Count allowed outbound requests by destination FQDN
    parse @message /CONNECT (?<destination>.+:\d+) /
    | stats count() as count by destination
    | sort count desc

outboundproxy/blocked-requests:
  logs:
    - ${env}_/var/log/squid/access.log
  query: |
    ## Find blocked outbound requests
    filter @message like "TCP_DENIED"

outboundproxy/blocked-requests-by-destination:
  logs:
    - ${env}_/var/log/squid/access.log
  query: |
    ## Count blocked outbound requests by destionation FQDN
    filter @message like "TCP_DENIED"
    | parse @message /TCP_DENIED\/403 \d+ (CONNECT|GET|POST|PUT|HEAD) (?<destination>.+?) -/
    | stats count() as count by destination
    | sort count desc

pii/id-token-hint-use-by-redirect-uri:
  logs:
  - ${env}_/srv/idp/shared/log/production.log
  query: |
    ## Count use of id_token_hint in RP-Initiated logout by post_logout_redirect_uri value
    ## Remove this query after all SPs have converted to use of client_id
    filter path like "/openid_connect/logout" and path like "id_token_hint" | parse path /id_token_hint=.+?\\.(?<payload>.*?)\\./
    | parse path /post_logout_redirect_uri=https(:\\/\\/|%3A%2F%2F)(?<redirect_fqdn>.+?)(\\/|%2F)/
    | stats count() as count by redirect_fqdn
    | sort count desc

pivcac/errors-by-issuer:
  logs:
    - ${env}_/srv/pki-rails/shared/log/production.log
  query: |
    ## Count invalid certs by issuer
    filter valid = 0
    | filter issuer like /./
    | filter issuer not like /CN=Communications Server/
    | stats count(*) as count, latest(@message) as sample by issuer, error
    | sort by count desc

pivcac/failures-by-service-provider:
  logs:
    - ${env}_/srv/idp/shared/log/events.log
  query: |
    ## Count failed piv/cac auth attempts by service provider
    filter name = "Multi-Factor Authentication"
    | filter properties.event_properties.success = 0
    | filter properties.event_properties.multi_factor_auth_method = "piv_cac"
    | filter properties.service_provider like /./
    | stats count() as count by properties.service_provider as sp, properties.event_properties.errors.type as error
    | sort by count desc

provisioning/cloud-init-output:
  logs:
    - /var/log/cloud-init-output.log
  query: |
    ## Find startup/provisioning logs for instances in this environment
    fields @timestamp, @logStream, @message
    | filter @logStream like /\.${env}\.[a-z]+\.gov$/
    #
    ## Find IdP instances for environment
    # | filter @logStream like /^idp/
    #
    ## Or pick a specific instance
    # | filter @logStream like /i-053d9cf7cc0bb5b32/
    #
    ## Only select the end result (CONTINUE for Good, ABANDON for Bad)
    # | filter @message like "--lifecycle-action-result"
    #
    ## Show most recent lines first
    | sort @timestamp desc

rails/500s-by-controller:
  logs:
    - ${env}_/srv/idp/shared/log/production.log
    - ${env}_/srv/pki-rails/shared/log/production.log
  query: |
    ## Count Rails application server errors by controller
    filter status =~ /^5/ and ispresent(action)
    | stats count() as events by controller
    | sort events desc

rails/500s-by-path:
  logs:
    - ${env}_/srv/idp/shared/log/production.log
    - ${env}_/srv/pki-rails/shared/log/production.log
  query: |
    ## Count Rails application server errors by request path
    parse path /^(?<basepath>[^\\?]+)/
    | filter status =~ /^5/ and ispresent(action)
    | stats count() as events by basepath
    | sort events desc

saml/endpoint-year-by-referrer:
  logs:
    - ${env}_/var/log/nginx/access.log
  query: |
    ## Count SAML endpoint request year by referrer, sorted by oldest year
    filter uri_path =~ /^\/api\/saml\/auth/
    | parse uri_path /auth(post)*(?<year>\d+)$/
    | filter http_referer not like /\.(login|identitysandbox)\.gov/
    | stats count() as count by http_referer,year
    | sort year asc

saml/valid-endpoint-years-by-service-provider:
  logs:
    - ${env}_/srv/idp/shared/log/events.log
  query: |
    ## Count SAML endpoint request year by issuer, sorted by count. Will not return invalid years.
    fields @timestamp, properties.event_properties.service_provider
    | filter name like /SAML Auth Request/
    | parse properties.path /\/api\/saml\/auth(post)*(?<year>\d+)$/
    # | filter year = 2024
    | stats count(*) as c by properties.event_properties.service_provider, year
    | sort c desc


telephony/otp-setup-by-ip:
  logs:
    - ${env}_/srv/idp/shared/log/events.log
  query: |
    ## Count one time password delivery setup grouped by user IP address per hour
    filter name ="Multi-Factor Authentication: enter OTP visited"
    | stats count(*) as count by properties.user_ip, bin(1h)
    | sort count desc

telephony/otp-phone-by-country:
  logs:
    - ${env}_/srv/idp/shared/log/events.log
  query: |
    ## Count one time password selection grouped by phone number country code
    fields @message, @timestamp
    | filter name = 'OTP: Delivery Selection'
    # Uncomment to only filter on authentication context
    # | filter properties.event_properties.context = 'authentication'
    | stats count_distinct(properties.user_id) as count by properties.event_properties.country_code
    | sort count desc

telephony/phone-setup-by-carrier-and-type:
  logs:
    - ${env}_/srv/idp/shared/log/events.log
  query: |
    ## Count active user phone numbers grouped by country code
    fields @message, @timestamp
    | filter ispresent(properties.event_properties.carrier)
    | stats count() as count by properties.event_properties.carrier,properties.event_properties.phone_type
    | sort count desc

users/events-by-user_id:
  logs:
    - ${env}_/srv/idp/shared/log/events.log
  query: |
    ## Find all events for a given UUID
    fields @timestamp, name, @message
    # Replace anonymous-uuid with the UUID you want to search for
    | filter properties.user_id = 'anonymous-uuid'
    | sort @timestamp asc

users/web-requests-by-user_id:
  logs:
    - ${env}_/srv/idp/shared/log/production.log
  query: |
    ## Find all application server requests for a given UUID
    fields @timestamp, concat(controller, '#', action) as name, @message
    # Replace anonymous-uuid with the UUID you want to search for
    | filter user_id = 'anonymous-uuid'
    | sort @timestamp asc

waf/blocked-by-path:
  logs:
    - aws-waf-logs-${env}-idp-waf
  query: |
    ## Cloudfront WAF is in us-east-1, be sure to check there as well!
    ## Count requests blocked by WAF grouped by HTTP method and URI
    filter action != "ALLOW"
    | stats count() as count by httpRequest.httpMethod,httpRequest.uri
    | sort count desc

waf/blocked-by-rule-and-ip:
  logs:
    - aws-waf-logs-${env}-idp-waf
  query: |
    ## Cloudfront WAF is in us-east-1, be sure to check there as well!
    ## Count requests blocked by WAF grouped by the blocking rule and client IP
    filter action != "ALLOW"
    | stats count() as count by terminatingRuleId,httpRequest.clientIp
    | sort count desc

workers/failed_jobs:
  logs:
    - ${env}_/srv/idp/shared/log/workers.log
  query: |
    ## Shows jobs that raised an exception while running
    fields @timestamp, @message
    | filter ispresent(exception_class) and name = 'perform.active_job'

ssm/aws-ssm-commands:
  logs:
    - aws-ssm-cmds-${env}
  query: |
    ## Shows ssm sessions started in an environment
    filter detail.eventName = "StartSession"
    | fields @timestamp, detail.responseElements.sessionId as sessionId, detail.requestParameters.documentName as documentName, detail.sourceIPAddress as sourceIPAddress, detail.userIdentity.arn as userIdentityArn, detail.userIdentity.accessKeyId as accessKeyId
    ## Uncomment to search for activity by a specific user
    # | filter userIdentity like /paul.doom/
    ## Uncomment to search for activity by a specific ssm document name
    # | filter documentName like /action-account/
    ## Uncomment to search for activity by a specific source address
    # | filter sourceIPAddress like /8.8.8.8/
    ## Uncomment to search for activity by a specific sessionId
    # | filter sessionId like /paul.doom-06e40423815d036e1/
    ## Uncomment to search for activity by a specific accessKeyId
    # | filter accessKeyId like /ASIA5AXYIREUFHDAQF12/
ssm/aws-ssm-output:
  logs:
    - aws-ssm-sessions-${env}
  query: |
    ## Shows ssm command output in an environment
    fields @timestamp, sessionId, target.id as instance, runAsUser
    | parse @message /"sessionData":\[(?<ssmOutput>.*?)\]/
    | display @timestamp, sessionId, target.id as instance, runAsUser, ssmOutput
    ## Uncomment to search for activity by a specific user
    # | filter runAsUser like /paul.doom/
    ## Uncomment to search for activity by a specific sessionId
    # | filter sessionId like /paul.doom-123456789asdfghjk/
    ## Uncomment to search for activity from a specific instance
    # | filter instance like /i-123456789asdfghjk/
