---
database/idp-postgresql-unusual-messages:
  logs:
  - /aws/rds/instance/login-${env}-idp/postgresql
  query: |
    filter @message not like /DETAIL:/
    | filter @message not like /STATEMENT:\s+INSERT/
    | filter @message not like /ERROR:\s+duplicate/
    | filter @message not like /LOG:\s+(checkpoint|duration|recovery|restartpoint)/

idp/events-by-user_id:
  logs:
  - ${env}_/srv/idp/shared/log/events.log
  query: |
    fields @timestamp, name, @message
    # Replace anonymous-uuid with the UUID you want to search for
    | filter properties.user_id = 'anonymous-uuid'
    | sort @timestamp asc

idp/web-requests-by-user_id:
  logs:
  - ${env}_/srv/idp/shared/log/production.log
  query: |
    fields @timestamp, concat(controller, '#', action) as name, @message
    # Replace anonymous-uuid with the UUID you want to search for
    | filter user_id = 'anonymous-uuid'
    | sort @timestamp asc

nginx/errors-by-source:
  logs:
  - ${env}_/var/log/nginx/access.log
  query: |
    filter status like /^5/
    #
    ## Only look in idp logs
    # | filter @logStream like /^idp/
    ## Only look in pivcac logs
    # | filter @logStream like /^pivcac/
    #
    ## Group by status, path, and source IP
    # | stats count() as count by status, uri_path, src
    ## Or just by source IP
    # | stats count() as count by src
    #
    | sort count desc

outboundproxy/allowed-requests-by-destination:
  logs:
  - ${env}_/var/log/squid/access.log
  query: |
    parse @message /CONNECT (?<destination>.+:\d+) /
    | stats count() as count by destination
    | sort count desc

outboundproxy/blocked-requests:
  logs:
  - ${env}_/var/log/squid/access.log
  query: |
    filter @message like "TCP_DENIED"

outboundproxy/blocked-requests-by-destination:
  logs:
  - ${env}_/var/log/squid/access.log
  query: |
    filter @message like "TCP_DENIED"
    | parse @message /TCP_DENIED\/403 \d+ CONNECT (?<destination>.+:\d+) /
    | stats count() as count by destination
    | sort count desc

provisioning/cloud-init-output:
  logs:
  - /var/log/cloud-init-output.log
  query: |
    fields @timestamp, @logStream, @message
    | filter @logStream like /\.${env}\.[a-z]+\.gov$/
    #
    ## Find IdP instances for environment
    # | filter @logStream like /^idp/
    #
    ## Or pick a specific instance
    # | filter @logStream like /i-053d9cf7cc0bb5b32/
    #
    ## Only select the end result (CONTINUE for Good, ABANDON for Bad)
    # | filter @message like "--lifecycle-action-result"
    #
    ## Uncomment to show earliest lines first
    # | sort @timestamp asc

rails/500s-by-controller:
  logs:
   - ${env}_/srv/idp/shared/log/production.log
   - ${env}_/srv/pki-rails/shared/log/production.log
  query: |
    filter status =~ /^5/
    | stats count() as events by controller
    | sort events desc

rails/500s-by-path:
  logs:
   - ${env}_/srv/idp/shared/log/production.log
   - ${env}_/srv/pki-rails/shared/log/production.log
  query: |
    parse path /^(?<basepath>[^\\?]+)/
    | filter status =~ /^5/
    | stats count() as events by basepath
    | sort events desc

telephony/otp-phone-by-country:
  logs:
   - ${env}_/srv/idp/shared/log/events.log
  query: |
    fields @message, @timestamp
    | filter name = 'OTP: Delivery Selection'
    # Uncomment to only filter on authentication context
    # | filter properties.event_properties.context = 'authentication'
    | stats count_distinct(properties.user_id) as count by properties.event_properties.country_code
    | sort count desc

telephony/phone-setup-by-carrier-and-type:
  logs:
   - ${env}_/srv/idp/shared/log/events.log
  query: |
    fields @message, @timestamp
    | filter ispresent(properties.event_properties.carrier)
    | stats count() as count by properties.event_properties.carrier,properties.event_properties.phone_type
    | sort count desc

waf/blocked-by-path:
  logs:
  - aws-waf-logs-${env}-idp-waf
  query: |
    filter action != "ALLOW"
    | stats count() as count by httpRequest.httpMethod,httpRequest.uri
    | sort count desc

waf/blocked-by-rule-and-ip:
  logs:
  - aws-waf-logs-${env}-idp-waf
  query: |
    filter action != "ALLOW"
    | stats count() as count by terminatingRuleId,httpRequest.clientIp
    | sort count desc

